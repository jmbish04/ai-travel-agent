<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voyant Metrics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { color: #555; margin-bottom: 10px; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .hint { font-size: 13px; color: #7a7a7a; margin-bottom: 12px; line-height: 1.4; }
        .metric { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .metric:last-child { border-bottom: none; }
        .metric-name { color: #666; }
        .metric-value { font-weight: bold; color: #333; }
        .status { text-align: center; padding: 10px; margin-bottom: 20px; border-radius: 4px; }
        .status.online { background: #d4edda; color: #155724; }
        .status.offline { background: #f8d7da; color: #721c24; }
        .refresh-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 20px; }
        .refresh-btn:hover { background: #0056b3; }
        .auto-refresh { margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Voyant Travel Assistant - Metrics Dashboard</h1>
        <p class="hint" style="text-align:center; max-width:760px; margin:0 auto 18px;">
            These cards answer two interview-critical questions: are answers grounded and helpful, and do we route/clarify fast enough to keep users happy?
        </p>

        <div id="status" class="status offline">Connecting...</div>

        <button class="refresh-btn" onclick="fetchMetrics()">üîÑ Refresh</button>
        <label class="auto-refresh">
            <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
        </label>

        <div class="grid">
            <div class="card">
                <h2>üèÅ Business Overview</h2>
                <p class="hint">FCR reveals how often we resolve without escalation, while TTR (avg ms) shows how quickly intents finish.</p>
                <div id="business"></div>
            </div>
            <div class="card">
                <h2>üìä Chat Activity</h2>
                <p class="hint">Turns per intent highlight demand hot-spots; sudden spikes often correlate with new features or regressions.</p>
                <div id="chatActivity"></div>
            </div>

            <div class="card">
                <h2>üéØ Router Performance</h2>
                <p class="hint">Low-confidence routes are early warning for off-topic replies or intents that need better training.</p>
                <div id="routerPerf"></div>
            </div>

            <div class="card">
                <h2>‚ùì Clarifications</h2>
                <p class="hint">Compare clarify requests vs resolved to confirm we collect missing slots instead of leaving users stuck.</p>
                <div id="clarifications"></div>
            </div>

            <div class="card">
                <h2>üîÑ Fallbacks</h2>
                <p class="hint">Web or browser fallback surges signal gaps in API coverage or flaky upstreams; investigate prolonged increases.</p>
                <div id="fallbacks"></div>
            </div>

            <div class="card">
                <h2>üìö Citations & Verification</h2>
                <p class="hint">Citation coverage and verify pass rate are our north-star for grounded answers from web search or RAG.</p>
                <div id="citations"></div>
            </div>

            <div class="card">
                <h2>üåê External Requests</h2>
                <p class="hint">Latency and status per target expose tool reliability‚Äîwatch for slow Brave/Tavily responses that erode relevance.</p>
                <div id="external"></div>
            </div>

            <div class="card">
                <h2>‚ö° Performance</h2>
                <p class="hint">E2E latency buckets keep us honest on UX; p95 should stay under the 3‚Äì6s band depending on cache/fresh data.</p>
                <div id="perf"></div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        function renderMetrics(key, value, container) {
            if (typeof value === 'object' && value !== null) {
                Object.entries(value).forEach(([k, v]) => {
                    container.innerHTML += `<div class="metric"><span class="metric-name">${k}</span><span class="metric-value">${v}</span></div>`;
                });
            } else {
                container.innerHTML += `<div class="metric"><span class="metric-name">${key}</span><span class="metric-value">${value}</span></div>`;
            }
        }

        async function fetchMetrics() {
            try {
                const response = await fetch('/metrics');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                document.getElementById('status').className = 'status online';
                document.getElementById('status').textContent = `‚úÖ Connected - Last updated: ${new Date().toLocaleTimeString()}`;

                // Clear containers
                ['business','chatActivity', 'routerPerf', 'clarifications', 'fallbacks', 'citations', 'external', 'perf'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });

                // Business Overview
                const bizDiv = document.getElementById('business');
                if (data.business) {
                    renderMetrics('total_sessions', data.business.total_sessions || 0, bizDiv);
                    renderMetrics('resolved_sessions', data.business.resolved_sessions || 0, bizDiv);
                    renderMetrics('fcr_rate', data.business.fcr_rate || 0, bizDiv);
                    if (data.business.session_outcomes) {
                        renderMetrics('outcomes', data.business.session_outcomes, bizDiv);
                    }
                    if (data.business.ttr_ms_by_intent) {
                        const ttrView = {};
                        for (const [k,v] of Object.entries(data.business.ttr_ms_by_intent)) {
                            // show avg_ms per intent
                            // @ts-ignore
                            ttrView[k] = (v && v.avg_ms) ? v.avg_ms : 0;
                        }
                        renderMetrics('ttr_avg_ms{intent}', ttrView, bizDiv);
                    }
                } else {
                    bizDiv.innerHTML = '<div class="metric"><span class="metric-name">Sessions</span><span class="metric-value">No data</span></div>';
                }

                // Chat Activity
                const chatDiv = document.getElementById('chatActivity');
                renderMetrics('Total Messages', data.messages_total, chatDiv);
                if (data.chat_turns && Object.keys(data.chat_turns).length > 0) {
                    renderMetrics('chat_turns', data.chat_turns, chatDiv);
                }

                // Router Performance
                const routerDiv = document.getElementById('routerPerf');
                if (data.router_low_conf && Object.keys(data.router_low_conf).length > 0) {
                    renderMetrics('low_confidence', data.router_low_conf, routerDiv);
                } else {
                    routerDiv.innerHTML = '<div class="metric"><span class="metric-name">Low Confidence</span><span class="metric-value">0</span></div>';
                }

                // Clarifications
                const clarifyDiv = document.getElementById('clarifications');
                if (data.clarify_requests && Object.keys(data.clarify_requests).length > 0) {
                    renderMetrics('requests', data.clarify_requests, clarifyDiv);
                }
                if (data.clarify_resolved && Object.keys(data.clarify_resolved).length > 0) {
                    renderMetrics('resolved', data.clarify_resolved, clarifyDiv);
                }
                if (clarifyDiv.innerHTML === '') {
                    clarifyDiv.innerHTML = '<div class="metric"><span class="metric-name">No clarifications yet</span><span class="metric-value">-</span></div>';
                }

                // Fallbacks
                const fallbackDiv = document.getElementById('fallbacks');
                if (data.fallbacks && Object.keys(data.fallbacks).length > 0) {
                    renderMetrics('fallbacks', data.fallbacks, fallbackDiv);
                } else {
                    fallbackDiv.innerHTML = '<div class="metric"><span class="metric-name">No fallbacks yet</span><span class="metric-value">-</span></div>';
                }

                // Citations & Verification
                const citDiv = document.getElementById('citations');
                renderMetrics('With Citations', data.answers_with_citations_total || 0, citDiv);
                if (data.quality) {
                    renderMetrics('verify_pass_rate', data.quality.verify_pass_rate || 0, citDiv);
                    renderMetrics('citation_coverage', data.quality.citation_coverage || 0, citDiv);
                }
                if (data.verify_fails && Object.keys(data.verify_fails).length > 0) {
                    renderMetrics('verify_fails', data.verify_fails, citDiv);
                }

                // External Requests
                const extDiv = document.getElementById('external');
                if (data.external_requests && data.external_requests.targets.length > 0) {
                    data.external_requests.targets.forEach(target => {
                        extDiv.innerHTML += `<div class="metric"><span class="metric-name">${target.target}</span><span class="metric-value">${target.total} (${target.latency.avg_ms}ms avg)</span></div>`;
                    });
                } else {
                    extDiv.innerHTML = '<div class="metric"><span class="metric-name">No external requests yet</span><span class="metric-value">-</span></div>';
                }

                // Performance
                const perfDiv = document.getElementById('perf');
                if (data.performance && data.performance.e2e_latency_ms) {
                    renderMetrics('e2e_avg_ms', data.performance.e2e_latency_ms.avg_ms || 0, perfDiv);
                    renderMetrics('e2e_pmin_ms', data.performance.e2e_latency_ms.min_ms || 0, perfDiv);
                    renderMetrics('e2e_pmax_ms', data.performance.e2e_latency_ms.max_ms || 0, perfDiv);
                    if (data.performance.e2e_latency_ms.buckets) {
                        renderMetrics('e2e_buckets_ms', data.performance.e2e_latency_ms.buckets, perfDiv);
                    }
                } else {
                    perfDiv.innerHTML = '<div class="metric"><span class="metric-name">E2E Latency</span><span class="metric-value">No data</span></div>';
                }

            } catch (error) {
                document.getElementById('status').className = 'status offline';
                document.getElementById('status').textContent = `‚ùå Error: ${error.message}`;
            }
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(fetchMetrics, 5000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);

        // Initial load
        fetchMetrics();
        toggleAutoRefresh();
    </script>
</body>
</html>
